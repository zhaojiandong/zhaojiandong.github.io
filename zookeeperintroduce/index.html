<!DOCTYPE html><html lang="zh-Hans"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Zookeeper介绍 | Source Code Cracker</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/3.0.3/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Zookeeper介绍</h1><a id="logo" href="/.">Source Code Cracker</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Zookeeper介绍</h1><div class="post-meta">Mar 1, 2016<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="zookeeperintroduce/" href="/zookeeperintroduce/#comments" class="ds-thread-count"></a><div class="post-content"><h2 id="What_is_ZooKeeper?">What is ZooKeeper?</h2><blockquote>
<p><a href="http://zookeeper.apache.org/doc/r3.3.2/zookeeperOver.html" target="_blank" rel="external">ZooKeeper</a>: A Distributed Coordination Service for Distributed Applications<br>ZooKeeper为分布式应用提供分布式协调服务，是Google的Chubby的开源实现。Zookeeper是一个高性能的分布式数据一致性解决方案，它并没直接采用Paxos算法，而是采用了一种被称ZAB（Zookeeper Atomic Broadcast）的一致性协议。</p>
</blockquote>
<h2 id="ZooKeeper功能点：">ZooKeeper功能点：</h2><ul>
<li>统一的命名服务(Name Service)</li>
<li>配置管理 (Maintaining Configuration)</li>
<li>集群管理(Group membership)</li>
<li>分布式锁(distributed synchronization)</li>
</ul>
<h2 id="ZooKeeper数据模型">ZooKeeper<a href="https://zookeeper.apache.org/doc/trunk/zookeeperOver.html" target="_blank" rel="external">数据模型</a></h2><p>ZooKeeper实现了一个类似于标准文件系统的数据结构，名称是由”/“分隔路径元素的序列。每一个节点在ZooKeeper的命名空间由路径唯一标识。如下图<br><img src="http://7xlamb.com1.z0.glb.clouddn.com/zknamespace.jpg" alt="ZK命名空间"><br>每个Znode由3部分组成：</p>
<ol>
<li>stat： 此为状态信息，描述该znode的版本，权限等信息。</li>
<li>data：与该znode关联的数据</li>
<li>children：该znode下的子节点</li>
</ol>
<h4 id="znode状态Stat信息">znode状态Stat信息</h4><blockquote>
<p>  <strong>czxid</strong>：znode创建时的zxid<br>    <strong>mzxid</strong>：znode最后一次修改时的zxid<br>    <strong>ctime</strong>：znode创建时的时间，单位毫秒<br>    <strong>mtime</strong>：znode最后一次修改的时间，单位毫秒<br>    <strong>version</strong>：znode修改的version(次数)<br>    <strong>cversion</strong>：修改znode子节点的version(次数)<br>    <strong>aversion</strong>：修改znode ACL的次数<br>    <strong>ephemeralOwner</strong>：如果znode是临时节点该值是Owner的session id，如果znode不是临时节点，该值是0<br>    <strong>dataLength</strong>：znode的数据字段的长度<br>    <strong>numChildren</strong>：这个znode子节点数量</p>
</blockquote>
<h4 id="znode类型">znode类型</h4><ul>
<li>EPHEMERAL：临时节点，生命周期依赖于client session，当session close/expire也会消失</li>
<li>EPHEMERAL_SEQUENTIAL ： (SEQUENTIAL意为顺序的) 顺序的临时节点</li>
<li>PERSISTENT ：持续的，不会随着session的close/expire而消失</li>
<li>PERSISTENT_SEQUENTIAL</li>
</ul>
<h2 id="典型的应用场景">典型的应用场景</h2><p><strong>1. 统一命名服务（Name Service）</strong><br>分布式应用中，通常需要有一套完整的命名规则，既能够产生唯一的名称又便于人识别和记住，通常情况下用树形的名称结构是一个理想的选择，树形的名称结构是一个有层次的目录结构，既对人友好又不会重复。ZooKeeper的命名服务类似于JNDI，它们都是将有层次的目录结构关联到一定资源上，但是 Zookeeper 的 Name Service 更加是广泛意义上的关联，也许你并不需要将名称关联到特定资源上，你可能只需要一个不会重复名称，就像数据库中产生一个唯一的数字主键一样。</p>
<p><strong>2. 数据发布与订阅（配置管理）</strong><br>数据发布与订阅系统，即是配置中心。发布者（Publisher）把数据发送到Zookeeper的服务器上（单机或者ZK集群），订阅者（Subscriber）进行数据订阅，订阅者注册自己需要关注的节点，一旦该节点的数据发生变化，那么ZK服务器就会向该订阅者发送watch事件通知，订阅者需要主动去服务器端后去最新的数据。</p>
<p><strong>3. 集群管理（Group Membership）</strong><br>随着应用集群的扩大，我们需要知道集群中每台机器的存活状态（集群监控），Zookeeper可以很容易的实现集群管理的功能。<br>我们在Zookeeper服务器上创建一个znode节点/Servers，集群中每一个节点在在启动是去注册一个临时（EPHEMERAL）节点/Servers/hostname（可以使用ip），然后每个节点在父节点/Servers上调用 getChildren(String path, boolean watch) 方法并设置 watch 为 true，由于是 EPHEMERAL节点有个特性，就是节点和Zookeeper服务器断开连接或者Session过期，节点都会被删除。NodeChildrenChanged 事件会通知到所有watch的客户端。<br><img src="http://7xlamb.com1.z0.glb.clouddn.com/clustermanagezkClusterManage.JPG" alt="集群管理"></p>
<p><strong>3. 分布式锁</strong><br>完全分布式锁是全局同步的，在任何时间快照意味着没有两个client同时持有同一把锁。这种分布式锁可以使用ZooKeeeper来实现。<br>ZooKeeper并没有直接给用户提供分布式锁，需要我们借助其节点来实现分布式锁，ZooKeeper可以实现两种锁：共享锁和排它锁<br>关于分布式锁请参看另一篇博文！！</p>
<h2 id="单机模式配置">单机模式配置</h2><p>单机模式安装和配置比较简单，下载压缩包zookeeper-3.3.6.tar.gz，然后解压到 /home/admin/zookeeper-3.3.6。配置文件在conf下面，需要重新命名zoo_sample.cfg 为 zoo.cfg，或者copy一份。<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">sudo</span> <span class="tag">cp</span> <span class="tag">zoo_sample</span><span class="class">.cfg</span> <span class="tag">zoo</span><span class="class">.cfg</span></span><br></pre></td></tr></table></figure></p>
<h5 id="配置如下：">配置如下：</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tickTime=<span class="number">2000</span>， tickTime是服务器之间或客户端与服务器之间心跳的时间间隔</span><br><span class="line">dataDir=/home/admin/zookeeper-<span class="number">3.3</span><span class="number">.6</span>/data，Zookeeper 保存数据的目录</span><br><span class="line">clientPort=<span class="number">2181</span>，Client连接 Zookeeper 服务器的端口，Zookeeper 会监听这个端口，接受客户端的访问请求</span><br></pre></td></tr></table></figure>
<h5 id="启动Zookeeper命令（启动脚本在_bin_目录）">启动Zookeeper命令（启动脚本在 bin 目录）</h5><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="keyword">sh</span> zkServer.<span class="keyword">sh</span> start</span><br></pre></td></tr></table></figure>
<h2 id="集群模式配置">集群模式配置</h2><p>Zookeeper 提供集群服务，下面介绍集群模式的安装和配置：</p>
<ul>
<li><p>配置hosts，首先修改/etc/hosts，为<strong>集群中所有机器</strong>配置一个hostName（主要为了方便配置Zookeeper）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">192.168</span><span class="number">.0</span><span class="number">.100</span>  zk-<span class="number">01</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.0</span><span class="number">.101</span>  zk-<span class="number">02</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.0</span><span class="number">.102</span>  zk-<span class="number">03</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>zoo.cfg 配置</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tickTime=<span class="number">2000</span></span><br><span class="line">dataDir=/home/admin/zookeeper-<span class="number">3.3</span><span class="number">.6</span>/data</span><br><span class="line">clientPort=<span class="number">2181</span></span><br><span class="line"></span><br><span class="line">initLimit=<span class="number">10</span> Zookeeper服务器集群中Leader最长能忍受Follower多少个心跳时间间隔数，<span class="number">10</span>*<span class="number">2000</span>ms=<span class="number">20</span>s</span><br><span class="line">syncLimit=<span class="number">5</span>  Leader与Follower之间发送消息，请求和应答时间间隔数，<span class="number">5</span>*<span class="number">2000</span>ms=<span class="number">10</span>s</span><br><span class="line">server<span class="number">.1</span>=zk-<span class="number">01</span>:<span class="number">2888</span>:<span class="number">3888</span></span><br><span class="line">server<span class="number">.2</span>=zk-<span class="number">02</span>:<span class="number">2888</span>:<span class="number">3888</span></span><br><span class="line">server<span class="number">.3</span>=zk-<span class="number">03</span>:<span class="number">2888</span>:<span class="number">3888</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>格式 server.X = A:B:C</p>
</blockquote>
<p>X 和下面要介绍的myid保持一致，A是hostName或者ip，B表示的集群中 Leader 和Follower通信端口；C 表示集群中Leader 挂了，重新选举时使用端口C。</p>
<ul>
<li><p>zoo.cfg配置的copy<br>为保证集群中所有的机器都使用同一份配置，用scp复制到集群中的其他机器（scp基于ssh登录）</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp -r zookeeper-<span class="number">3.3</span>.<span class="number">6</span>/ jiandong.zjd<span class="variable">@zk</span>-<span class="number">02</span><span class="symbol">:/home/admin/</span></span><br><span class="line">scp -r zookeeper-<span class="number">3.3</span>.<span class="number">6</span>/ jiandong.zjd<span class="variable">@zk</span>-<span class="number">03</span><span class="symbol">:/home/admin/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置myid<br>在zookeeper配置的dataDir指定的目录下面，创建一个myid文件，里面内容为一个数字，用来标识当前主机，zoo.cfg文件中配置的server.X中X是什么数字，则myid文件中就输入这个数字。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">zk-<span class="number">01</span>: echo <span class="string">"1"</span> &gt; /home/admin/zookeeper-<span class="number">3.3</span><span class="number">.6</span>/data/myid</span><br><span class="line">zk-<span class="number">01</span>: echo <span class="string">"2"</span> &gt; /home/admin/zookeeper-<span class="number">3.3</span><span class="number">.6</span>/data/myid</span><br><span class="line">zk-<span class="number">01</span>: echo <span class="string">"3"</span> &gt; /home/admin/zookeeper-<span class="number">3.3</span><span class="number">.6</span>/data/myid</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动集群，在ZooKeeper集群的每个结点上，执行启动ZooKeeper服务的脚本</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">sh</span> bin/zkServer.<span class="keyword">sh</span> start</span><br></pre></td></tr></table></figure>
</li>
<li><p>集群安装验证</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sh bin/zkServer.sh status</span><br><span class="line"></span><br><span class="line">sh bin/zkServer.sh status</span><br><span class="line">JMX enabled by <span class="keyword">default</span></span><br><span class="line">Using <span class="string">config:</span> <span class="regexp">/home/</span>admin<span class="regexp">/zookeeper-3.3.6/</span>bin<span class="regexp">/../</span>conf/zoo.cfg</span><br><span class="line"><span class="string">Mode:</span> follower</span><br></pre></td></tr></table></figure>
</li>
</ul>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://zhaojiandong.github.io/zookeeperintroduce/" data-id="cinq3h4rg0006o4to180ebl05" class="article-share-link">分享到</a><div class="tags"><a href="/tags/Zookeeper/">Zookeeper</a></div><div class="post-nav"><a href="/zookeeperlock/" class="pre">ZooKeeper分布式锁</a><a href="/java-class-loader/" class="next">Java类加载器详解</a></div><div data-thread-key="zookeeperintroduce/" data-title="Zookeeper介绍" data-url="http://zhaojiandong.github.io/zookeeperintroduce/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="zookeeperintroduce/" data-title="Zookeeper介绍" data-url="http://zhaojiandong.github.io/zookeeperintroduce/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://zhaojiandong.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/hexo-blog/" style="font-size: 15px;">hexo blog</a> <a href="/tags/Zookeeper/" style="font-size: 15px;">Zookeeper</a> <a href="/tags/SouceCode-ASM/" style="font-size: 15px;">SouceCode ASM</a> <a href="/tags/log-log4j/" style="font-size: 15px;">log, log4j</a> <a href="/tags/jvm-GC/" style="font-size: 15px;">jvm GC</a> <a href="/tags/ClassLoader-JVM/" style="font-size: 15px;">ClassLoader, JVM</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/network-tcp-ip/">TCP-IP详解</a></li><li class="post-list-item"><a class="post-list-link" href="/log4jdetail/">log4j配置详解</a></li><li class="post-list-item"><a class="post-list-link" href="/zookeeperlock/">ZooKeeper分布式锁</a></li><li class="post-list-item"><a class="post-list-link" href="/zookeeperintroduce/">Zookeeper介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/java-class-loader/">Java类加载器详解</a></li><li class="post-list-item"><a class="post-list-link" href="/hexo-optimization1/">Hexo 博客优化(NexT主题)</a></li><li class="post-list-item"><a class="post-list-link" href="/mysql-base/">mysql-base</a></li><li class="post-list-item"><a class="post-list-link" href="/scc-asm/">SourceCode Crack——ASM</a></li><li class="post-list-item"><a class="post-list-link" href="/jvm-base/">JVM垃圾收集算法</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> 最近评论</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.google.com.hk/" title="Google" target="_blank">Google</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Source Code Cracker.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'zhaojiandong'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>